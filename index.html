<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiLog - Steer Your Reporting</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Your existing CSS styles here */
    </style>
</head>
<body>
    <div class="container">
        <div class="report-form" id="reportFormContainer">
            <h2>OptiLog - Steer Your Reporting</h2>
            <form id="reportForm">
                <div id="dynamicSections"></div>
                <button type="submit">Submit Report</button>
            </form>
        </div>
        <div class="chatbot">
            <div class="chatbot-header">
                <h2>NaVya</h2>
            </div>
            <div id="chatMessages" class="chatbot-messages"></div>
            <div class="chatbot-input">
                <input id="userInput" type="text" placeholder="Type your message and press Enter">
            </div>
        </div>
    </div>

    <script>
        const SECTION_FIELDS = {
            "Vessel Data": ["Vessel Name", "Vessel IMO", "Vessel Type"],
            "Voyage Data": ["Local Date", "Local Time", "UTC Offset", "Voyage ID", "Segment ID", "From Port", "To Port"],
            "Event Data": ["Event Type", "Time Elapsed (hours)", "Sailing Time (hours)", "Anchor Time (hours)", "Ice Time (hours)", "Maneuvering (hours)", "Loading/Unloading (hours)", "Drifting (hours)"],
            "Position": ["Latitude Degrees", "Latitude Minutes", "Latitude Direction", "Longitude Degrees", "Longitude Minutes", "Longitude Direction"],
            "Cargo": {
                "Oil Tanker": ["Cargo Weight (mt)"],
                "LPG Tanker": ["Cargo Volume (m3)"],
                "LNG Tanker": ["Cargo Volume (m3)"]
            },
            "Fuel Consumption": {
                "Oil Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LPG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME LPG Propane (mt)", "ME LPG Butane (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE LPG Propane (mt)", "AE LPG Butane (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler LPG Propane (mt)", "Boiler LPG Butane (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG LPG Propane (mt)", "IGG LPG Butane (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LNG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "GCU": ["GCU LFO (mt)", "GCU MGO (mt)", "GCU LNG (mt)", "GCU Other (mt)", "GCU Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                }
            },
            "ROB": ["LFO ROB (mt)", "MGO ROB (mt)", "LNG ROB (mt)", "Other ROB (mt)", "Other Fuel Type ROB", "Total Fuel ROB (mt)"],
            "Fuel Allocation": {
                "Oil Tanker": {
                    "Cargo Heating": [
                        "Cargo Heating HFO (mt)", 
                        "Cargo Heating MGO (mt)", 
                        "Cargo Heating LNG (mt)", 
                        "Cargo Heating Other (mt)", 
                        "Cargo Heating Other Fuel Type"
                    ],
                    "Cargo Discharging": [
                        "Cargo Discharging HFO (mt)",
                        "Cargo Discharging MGO (mt)",
                        "Cargo Discharging LNG (mt)",
                        "Cargo Discharging Other (mt)",
                        "Cargo Discharging Other Fuel Type"
                    ],
                    "Engine Driven Cargo Pump": ["Engine Driven Cargo Pump MGO (mt)"]
                },
                "LPG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LNG (mt)",
                        "Cargo Cooling LPG Propane (mt)", "Cargo Cooling LPG Butane (mt)",
                        "Cargo Cooling Other (mt)", "Cargo Cooling Other Fuel Type",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)", "Discharge Pump LNG (mt)",
                        "Discharge Pump LPG Propane (mt)", "Discharge Pump LPG Butane (mt)",
                        "Discharge Pump Other (mt)", "Discharge Pump Other Fuel Type",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                },
                "LNG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LNG (mt)",
                        "Cargo Cooling Other (mt)", "Cargo Cooling Other Fuel Type",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)", "Discharge Pump LNG (mt)",
                        "Discharge Pump Other (mt)", "Discharge Pump Other Fuel Type",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                }
            },
            "Weather": {
                "Wind": ["Wind Direction (degrees)", "Wind Speed (knots)", "Wind Force (Beaufort)"],
                "Sea State": ["Sea State Direction (degrees)", "Sea State Force (Douglas scale)", "Sea State Period (seconds)"],
                "Swell": ["Swell Direction (degrees)", "Swell Height (meters)", "Swell Period (seconds)"],
                "Current": ["Current Direction (degrees)", "Current Speed (knots)"],
                "Temperature": ["Air Temperature (°C)", "Sea Temperature (°C)"]
            },
            "Draft": {
                "Actual": ["Actual Forward Draft (m)", "Actual Aft Draft (m)", "Displacement (mt)", "Water Depth (m)"]
            }
        };

        const BUNKERING_FIELDS = [
            "Bunker Type",
            "Quantity (mt)",
            "Density at 15°C (kg/m3)",
            "Viscosity at 50°C (cSt)",
            "Flash Point (°C)",
            "Sulphur Content (%)",
            "Water Content (%)",
            "Ash Content (%)",
            "Vanadium (mg/kg)",
            "Aluminium + Silicon (mg/kg)",
            "Pour Point (°C)",
            "Supplier Name",
            "Delivery Date",
            "Delivery Port",
            "BDN Number"
        ];

        const REPORT_TYPES = [
            "Arrival", "Departure", "Begin of offhire", "End of offhire", "Arrival STS", "Departure STS",
            "STS", "Begin canal passage", "End canal passage", "Begin of sea passage", "End of sea passage",
            "Begin Anchoring/Drifting", "End Anchoring/Drifting", "Noon (Position) - Sea passage",
            "Noon (Position) - Port", "Noon (Position) - River", "Noon (Position) - Stoppage",
            "ETA update", "Begin fuel change over", "End fuel change over", "Change destination (Deviation)",
            "Begin of deviation", "End of deviation", "Entering special area", "Leaving special area",
            "Other event", "Bunkering"
        ];

        let currentVesselType = '';
        let currentReportType = '';
        let currentSection = '';
        let currentField = '';
        let currentSectionIndex = 0;
        let currentFieldIndex = 0;
        let conversationState = 'start';
        let userExpandedSections = new Set();

        const chatbotContainer = document.getElementById('chatMessages');

        async function getOpenAIResponse(prompt) {
            // Your existing OpenAI API call function
        }

        function addChatbotMessage(message, isUser = false) {
            // Your existing addChatbotMessage function
        }

        async function handleUserInput(userInput) {
            // Your existing handleUserInput function
        }

        function generateRandomLatLong() {
            // Your existing generateRandomLatLong function
        }

        function generateRandomConsumption(min, max) {
            // Your existing generateRandomConsumption function
        }

        function generateRandomVesselName() {
            // Your existing generateRandomVesselName function
        }

        function generateRandomIMO() {
            // Your existing generateRandomIMO function
        }

        function generateFormFields(vesselType) {
            const dynamicSections = document.getElementById('dynamicSections');
            dynamicSections.innerHTML = '';

            const randomPosition = generateRandomLatLong();
            const randomVesselName = generateRandomVesselName();
            const randomIMO = generateRandomIMO();

            for (const section in SECTION_FIELDS) {
                const fields = SECTION_FIELDS[section];
                let sectionFields = [];

                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    if (fields[vesselType]) {
                        sectionFields = fields[vesselType];
                    } else if (section === "Cargo" || section === "Fuel Consumption" || section === "Fuel Allocation") {
                        // For these sections, we want to keep the nested structure
                        sectionFields = fields;
                    } else {
                        sectionFields = fields;
                    }
                } else {
                    sectionFields = fields;
                }

                if (sectionFields && Object.keys(sectionFields).length > 0) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('form-section');
                    sectionDiv.id = section.replace(/\s+/g, '-').toLowerCase();
                    
                    const sectionHeader = document.createElement('div');
                    sectionHeader.classList.add('form-section-header');
                    sectionHeader.innerHTML = `<h3>${section}</h3>`;
                    sectionHeader.addEventListener('click', () => toggleSection(sectionDiv));
                    
                    const sectionContent = document.createElement('div');
                    sectionContent.classList.add('form-section-content');

                    sectionDiv.appendChild(sectionHeader);
                    sectionDiv.appendChild(sectionContent);

                    const createFields = (fields, parentSection) => {
                        let formRow;
                        fields.forEach((field, index) => {
                            if (index % 3 === 0) {
                                formRow = document.createElement('div');
                                formRow.classList.add('form-row');
                                sectionContent.appendChild(formRow);
                            }

                            const formGroup = document.createElement('div');
                            formGroup.classList.add('form-group');
                            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
                            let value = '';
                            let infoMessage = '';

                            // Add logic for setting default values and info messages here
                            if (section === 'Position' && field.includes('Latitude')) {
                                if (field.includes('Degrees')) value = randomPosition.latDeg;
                                else if (field.includes('Minutes')) value = randomPosition.latMin;
                                else if (field.includes('Direction')) value = randomPosition.latDir;
                                infoMessage = 'Current AIS position';
                            } else if (section === 'Position' && field.includes('Longitude')) {
                                if (field.includes('Degrees')) value = randomPosition.longDeg;
                                else if (field.includes('Minutes')) value = randomPosition.longMin;
                                else if (field.includes('Direction')) value = randomPosition.longDir;
                                infoMessage = 'Current AIS position';
                            } else if (field === 'Vessel Name') {
                                value = randomVesselName;
                            } else if (field === 'Vessel IMO') {
                                value = randomIMO;
                            } else if (field.includes('LFO')) {
                                if (parentSection === 'Main Engine') {
                                    value = generateRandomConsumption(20, 25);
                                } else if (parentSection === 'Auxiliary Engines') {
                                    value = generateRandomConsumption(2, 3);
                                } else if (parentSection === 'Boilers') {
                                    value = generateRandomConsumption(1, 2);
                                }
                                infoMessage = 'MFM figures since last report';
                            }

                            formGroup.innerHTML = `
                                <label for="${fieldId}">${field}:</label>
                                <input type="text" id="${fieldId}" name="${field}" value="${value}">
                                ${infoMessage ? `<div class="info-message">${infoMessage}</div>` : ''}
                            `;
                            formRow.appendChild(formGroup);
                        });
                    };

                    if (Array.isArray(sectionFields)) {
                        createFields(sectionFields, section);
                    } else {
                        for (const subsection in sectionFields) {
                            if (section === "Cargo" || section === "Fuel Consumption" || section === "Fuel Allocation") {
                                // For these sections, we only want to show fields for the current vessel type
                                if (subsection === vesselType) {
                                    for (const subsubsection in sectionFields[subsection]) {
                                        const subsectionDiv = document.createElement('div');
                                        subsectionDiv.innerHTML = `<h4>${subsubsection}</h4>`;
                                        sectionContent.appendChild(subsectionDiv);
                                        createFields(sectionFields[subsection][subsubsection], subsubsection);
                                    }
                                }
                            } else {
                                const subsectionDiv = document.createElement('div');
                                subsectionDiv.innerHTML = `<h4>${subsection}</h4>`;
                                sectionContent.appendChild(subsectionDiv);
                                createFields(sectionFields[subsection], subsection);
                            }
                        }
                    }

                    dynamicSections.appendChild(sectionDiv);
                }
            }

            // Add Bunkering section if it's a Bunkering report
            if (currentReportType.toLowerCase() === 'bunkering') {
                const bunkeringSection = document.createElement('div');
                bunkeringSection.classList.add('form-section');
                bunkeringSection.id = 'bunkering';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.classList.add('form-section-header');
                sectionHeader.innerHTML = `<h3>Bunkering</h3>`;
                sectionHeader.addEventListener('click', () => toggleSection(bunkeringSection));
                
                const sectionContent = document.createElement('div');
                sectionContent.classList.add('form-section-content');

                bunkeringSection.appendChild(sectionHeader);
                bunkeringSection.appendChild(sectionContent);

                let formRow;
                BUNKERING_FIELDS.forEach((field, index) => {
                    if (index % 3 === 0) {
                        formRow = document.createElement('div');
                        formRow.classList.add('form-row');
                        sectionContent.appendChild(formRow);
                    }

                    const formGroup = document.createElement('div');
                    formGroup.classList.add('form-group');
                    const fieldId = field.replace(/\s+/g, '-').toLowerCase();

                    formGroup.innerHTML = `
                        <label for="${fieldId}">${field}:</label>
                        <input type="text" id="${fieldId}" name="${field}">
                    `;
                    formRow.appendChild(formGroup);
                });

                dynamicSections.appendChild(bunkeringSection);
            }
        }

        function toggleSection(section) {
            section.classList.toggle('expanded');
            if (section.classList.contains('expanded')) {
                userExpandedSections.add(section.id);
            } else {
                userExpandedSections.delete(section.id);
            }
        }

        function expandSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && !section.classList.contains('expanded')) {
                section.classList.add('expanded');
            }
        }

        function collapseSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && section.classList.contains('expanded') && !userExpandedSections.has(sectionId)) {
                section.classList.remove('expanded');
            }
        }

        function fillInitialFormFields() {
            fillFormField('Vessel Type', currentVesselType);

            const now = new Date();
            fillFormField('Local Date', now.toISOString().split('T')[0]);
            fillFormField('Local Time', now.toTimeString().split(' ')[0]);
            
            const offset = -now.getTimezoneOffset() / 60;
            fillFormField('UTC Offset', offset.toString());

            const year = now.getFullYear().toString().substr(-2);
            const ladenOrBallast = Math.random() < 0.5 ? 'L' : 'B';
            const voyageId = `${Math.floor(Math.random() * 9 + 1)}/${year}/${ladenOrBallast}`;
            fillFormField('Voyage ID', voyageId);

            const segmentId = Math.floor(Math.random() * 5 + 1).toString();
            fillFormField('Segment ID', segmentId);

            const ports = ['Singapore', 'Rotterdam', 'Shanghai', 'Los Angeles', 'Dubai', 'Hamburg', 'New York'];
            const fromPort = ports[Math.floor(Math.random() * ports.length)];
            let toPort;
            do {
                toPort = ports[Math.floor(Math.random() * ports.length)];
            } while (toPort === fromPort);
            fillFormField('From Port', fromPort);
            fillFormField('To Port', toPort);

            fillFormField('Event Type', currentReportType);
        }

        function fillFormField(field, value) {
            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
            const inputElement = document.getElementById(fieldId);
            if (inputElement) {
                inputElement.value = value;
            }
        }

        function askNextField() {
            const sections = Object.keys(SECTION_FIELDS);
            while (currentSectionIndex < sections.length) {
                currentSection = sections[currentSectionIndex];
                let fields = SECTION_FIELDS[currentSection];
                
                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    fields = fields[currentVesselType] || Object.values(fields).flat();
                }

                while (currentFieldIndex < fields.length) {
                    currentField = fields[currentFieldIndex];
                    const fieldId = currentField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    
                    if (inputElement && !inputElement.value) {
                        addChatbotMessage(`Please provide the ${currentField} (or type 'null' to skip):`);
                        expandSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                        return;
                    }
                    currentFieldIndex++;
                }
                collapseSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                currentSectionIndex++;
                currentFieldIndex = 0;
            }

            // Check for Bunkering fields if it's a Bunkering report
            if (currentReportType.toLowerCase() === 'bunkering' && currentSectionIndex === sections.length) {
                while (currentFieldIndex < BUNKERING_FIELDS.length) {
                    currentField = BUNKERING_FIELDS[currentFieldIndex];
                    const fieldId = currentField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    
                    if (inputElement && !inputElement.value) {
                        addChatbotMessage(`Please provide the ${currentField} (or type 'null' to skip):`);
                        expandSection('bunkering');
                        return;
                    }
                    currentFieldIndex++;
                }
            }

            addChatbotMessage("Great job! You've completed all the fields. Would you like to submit the report now?");
            conversationState = 'confirm_submit';
        }

        function handleSubmissionConfirmation(userInput) {
            if (userInput.toLowerCase().includes('yes') || userInput.toLowerCase().includes('submit')) {
                submitReport();
            } else {
                addChatbotMessage("Okay, we won't submit the report yet. Let me know when you're ready to submit or if you need to make any changes.");
                conversationState = 'filling_form';
            }
        }

        function submitReport() {
            const formData = new FormData(document.getElementById('reportForm'));
            const reportData = Object.fromEntries(formData.entries());
            console.log("Submitting report:", reportData);
            
            addChatbotMessage("Report submitted successfully! Here's a summary of your report:");
            for (const [key, value] of Object.entries(reportData)) {
                addChatbotMessage(`${key}: ${value}`);
            }
            
            initApp();
        }

        function initApp() {
            console.log("Initializing application...");
            conversationState = 'start';
            currentVesselType = '';
            currentReportType = '';
            currentSection = '';
            currentField = '';
            currentSectionIndex = 0;
            currentFieldIndex = 0;
            userExpandedSections.clear();
            document.getElementById('dynamicSections').innerHTML = '';
            document.getElementById('chatMessages').innerHTML = '';
            addChatbotMessage("Welcome to NaVya, your maritime reporting assistant! I'm here to help you create a report. Please tell me the type of vessel you're reporting for (Container vessel, Bulk Carrier, Oil Tanker, LPG tanker, or LNG tanker).");
        }

        document.getElementById('userInput').addEventListener('keypress', async function(event) {
            if (event.key === 'Enter') {
                const userInput = event.target.value.trim();
                event.target.value = '';
                if (userInput) {
                    await handleUserInput(userInput);
                }
            }
        });

        document.getElementById('reportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            addChatbotMessage("It looks like you're trying to submit the form. Are you sure you want to submit the report now?");
            conversationState = 'confirm_submit';
        });

        window.onload = initApp;
    </script>
</body>
</html>
