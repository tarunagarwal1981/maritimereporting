<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiLog - Advanced Interactive Maritime Reporting System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .container {
            display: flex;
            height: 100%;
        }
        .report-form {
            width: 60%;
            padding: 20px;
            overflow-y: auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .chatbot {
            width: 40%;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            border-left: 1px solid #e0e0e0;
        }
        .chatbot-header {
            padding: 20px;
            background-color: #3498db;
            color: white;
            font-weight: 500;
        }
        .chatbot-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .chatbot-input {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .form-section {
            margin-bottom: 20px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid #e6e6e6;
        }
        .form-section.highlight {
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
        }
        .form-section-header {
            cursor: pointer;
            user-select: none;
        }
        .form-section-content {
            display: none;
        }
        .form-section.expanded .form-section-content {
            display: block;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .form-group {
            flex: 1 1 30%;
            min-width: 200px;
            padding: 0 10px;
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            transition: border-color 0.3s ease;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #3498db;
            outline: none;
        }
        #userInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .chatbot-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
            font-size: 14px;
        }
        .user-message {
            background-color: #e6f2ff;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background-color: #f0f0f0;
            align-self: flex-start;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #2980b9;
        }
        .field-prompt {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        .info-message {
            font-size: 11px;
            color: #0066cc;
            background-color: #e6f2ff;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="report-form" id="reportFormContainer">
            <h2>Maritime Report</h2>
            <form id="reportForm">
                <div id="dynamicSections"></div>
                <button type="submit">Submit Report</button>
            </form>
        </div>
        <div class="chatbot">
            <div class="chatbot-header">
                <h2>AI Assistant</h2>
            </div>
            <div id="chatMessages" class="chatbot-messages"></div>
            <div class="chatbot-input">
                <input id="userInput" type="text" placeholder="Type your message and press Enter">
            </div>
        </div>
    </div>

    <script>
        const SECTION_FIELDS = {
            "Vessel Data": ["Vessel Name", "Vessel IMO", "Vessel Type"],
            "Voyage Data": ["Local Date", "Local Time", "UTC Offset", "Voyage ID", "Segment ID", "From Port", "To Port"],
            "Event Data": ["Event Type", "Time Elapsed (hours)", "Sailing Time (hours)", "Anchor Time (hours)", "Ice Time (hours)", "Maneuvering (hours)", "Loading/Unloading (hours)", "Drifting (hours)"],
            "Position": ["Latitude Degrees", "Latitude Minutes", "Latitude Direction", "Longitude Degrees", "Longitude Minutes", "Longitude Direction"],
            "Cargo": {
                "Oil Tanker": ["Cargo Weight (mt)"],
                "LPG Tanker": ["Cargo Volume (m3)"],
                "LNG Tanker": ["Cargo Volume (m3)"]
            },
            "Fuel Consumption": {
                "Oil Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LPG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME LPG Propane (mt)", "ME LPG Butane (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE LPG Propane (mt)", "AE LPG Butane (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler LPG Propane (mt)", "Boiler LPG Butane (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG LPG Propane (mt)", "IGG LPG Butane (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LNG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "GCU": ["GCU LFO (mt)", "GCU MGO (mt)", "GCU LNG (mt)", "GCU Other (mt)", "GCU Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                }
            },
            "ROB": ["LFO ROB (mt)", "MGO ROB (mt)", "LNG ROB (mt)", "Other ROB (mt)", "Other Fuel Type ROB", "Total Fuel ROB (mt)"],
            "Fuel Allocation": {
                "Oil Tanker": {
                    "Cargo Heating": [
                        "Cargo Heating HFO (mt)", 
                        "Cargo Heating MGO (mt)", 
                        "Cargo Heating LNG (mt)", 
                        "Cargo Heating Other (mt)", 
                        "Cargo Heating Other Fuel Type"
                    ],
                    "Cargo Discharging": [
                        "Cargo Discharging HFO (mt)",
                        "Cargo Discharging MGO (mt)",
                        "Cargo Discharging LNG (mt)",
                        "Cargo Discharging Other (mt)",
                        "Cargo Discharging Other Fuel Type"
                    ],
                    "Engine Driven Cargo Pump": ["Engine Driven Cargo Pump MGO (mt)"]
                },
                "LPG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LNG (mt)",
                        "Cargo Cooling LPG Propane (mt)", "Cargo Cooling LPG Butane (mt)",
                        "Cargo Cooling Other (mt)", "Cargo Cooling Other Fuel Type",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)", "Discharge Pump LNG (mt)",
                        "Discharge Pump LPG Propane (mt)", "Discharge Pump LPG Butane (mt)",
                        "Discharge Pump Other (mt)", "Discharge Pump Other Fuel Type",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                },
                "LNG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LNG (mt)",
                        "Cargo Cooling Other (mt)", "Cargo Cooling Other Fuel Type",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)", "Discharge Pump LNG (mt)",
                        "Discharge Pump Other (mt)", "Discharge Pump Other Fuel Type",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                }
            },
            "Weather": {
                "Wind": ["Wind Direction (degrees)", "Wind Speed (knots)", "Wind Force (Beaufort)"],
                "Sea State": ["Sea State Direction (degrees)", "Sea State Force (Douglas scale)", "Sea State Period (seconds)"],
                "Swell": ["Swell Direction (degrees)", "Swell Height (meters)", "Swell Period (seconds)"],
                "Current": ["Current Direction (degrees)", "Current Speed (knots)"],
                "Temperature": ["Air Temperature (°C)", "Sea Temperature (°C)"]
            },
            "Draft": {
                "Actual": ["Actual Forward Draft (m)", "Actual Aft Draft (m)", "Displacement (mt)", "Water Depth (m)"]
            }
        };

        let currentVesselType = '';
        let currentSection = '';
        let currentField = '';
        let currentSectionIndex = 0;
        let currentFieldIndex = 0;
        let conversationState = 'start';
        let userExpandedSections = new Set();

        const chatbotContainer = document.getElementById('chatMessages');

        function addChatbotMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chatbot-message');
            messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
            messageDiv.innerHTML = `<p>${isUser ? '<strong>You:</strong> ' : '<strong>AI Assistant:</strong> '}${message}</p>`;
            chatbotContainer.appendChild(messageDiv);
            chatbotContainer.scrollTop = chatbotContainer.scrollHeight;
        }

        function generateRandomLatLong() {
            const lat = Math.random() * 180 - 90;
            const long = Math.random() * 360 - 180;
            return {
                latDeg: Math.abs(Math.floor(lat)),
                latMin: Math.abs((lat % 1) * 60).toFixed(2),
                latDir: lat >= 0 ? 'N' : 'S',
                longDeg: Math.abs(Math.floor(long)),
                longMin: Math.abs((long % 1) * 60).toFixed(2),
                longDir: long >= 0 ? 'E' : 'W'
            };
        }

        function generateRandomConsumption(min, max) {
            return (Math.random() * (max - min) + min).toFixed(1);
        }

        function generateRandomVesselName() {
            const prefixes = ["MV", "SS", "MT"];
            const names = ["Horizon", "Voyager", "Pioneer", "Adventurer", "Explorer", "Discovery", "Navigator", "Endeavour", "Challenger", "Trailblazer"];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${names[Math.floor(Math.random() * names.length)]}`;
        }

        function generateRandomIMO() {
            return Math.floor(1000000 + Math.random() * 9000000).toString();
        }

        function generateFormFields(vesselType) {
            const dynamicSections = document.getElementById('dynamicSections');
            dynamicSections.innerHTML = '';

            const randomPosition = generateRandomLatLong();
            const randomVesselName = generateRandomVesselName();
            const randomIMO = generateRandomIMO();

            for (const section in SECTION_FIELDS) {
                const fields = SECTION_FIELDS[section];
                let sectionFields = [];

                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    if (fields[vesselType]) {
                        sectionFields = fields[vesselType];
                    } else if (section !== "Cargo" && section !== "Fuel Consumption" && section !== "Fuel Allocation") {
                        sectionFields = fields;
                    }
                } else {
                    sectionFields = fields;
                }

                if (sectionFields && Object.keys(sectionFields).length > 0) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('form-section');
                    sectionDiv.id = section.replace(/\s+/g, '-').toLowerCase();
                    
                    const sectionHeader = document.createElement('div');
                    sectionHeader.classList.add('form-section-header');
                    sectionHeader.innerHTML = `<h3>${section}</h3>`;
                    sectionHeader.addEventListener('click', () => toggleSection(sectionDiv));
                    
                    const sectionContent = document.createElement('div');
                    sectionContent.classList.add('form-section-content');

                    sectionDiv.appendChild(sectionHeader);
                    sectionDiv.appendChild(sectionContent);

                    const createFields = (fields, parentSection) => {
                        let formRow;
                        fields.forEach((field, index) => {
                            if (index % 3 === 0) {
                                formRow = document.createElement('div');
                                formRow.classList.add('form-row');
                                sectionContent.appendChild(formRow);
                            }

                            const formGroup = document.createElement('div');
                            formGroup.classList.add('form-group');
                            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
                            let value = '';
                            let infoMessage = '';

                            if (section === 'Position' && field.includes('Latitude')) {
                                if (field.includes('Degrees')) value = randomPosition.latDeg;
                                else if (field.includes('Minutes')) value = randomPosition.latMin;
                                else if (field.includes('Direction')) value = randomPosition.latDir;
                                infoMessage = 'Current AIS position';
                            } else if (section === 'Position' && field.includes('Longitude')) {
                                if (field.includes('Degrees')) value = randomPosition.longDeg;
                                else if (field.includes('Minutes')) value = randomPosition.longMin;
                                else if (field.includes('Direction')) value = randomPosition.longDir;
                                infoMessage = 'Current AIS position';
                            } else if (field === 'Vessel Name') {
                                value = randomVesselName;
                            } else if (field === 'Vessel IMO') {
                                value = randomIMO;
                            } else if (field.includes('LFO')) {
                                if (parentSection === 'Main Engine') {
                                    value = generateRandomConsumption(20, 25);
                                } else if (parentSection === 'Auxiliary Engines') {
                                    value = generateRandomConsumption(2, 3);
                                } else if (parentSection === 'Boilers') {
                                    value = generateRandomConsumption(1, 2);
                                }
                                infoMessage = 'MFM figures since last report';
                            }

                            formGroup.innerHTML = `
                                <label for="${fieldId}">${field}:</label>
                                <input type="text" id="${fieldId}" name="${field}" value="${value}">
                                ${infoMessage ? `<div class="info-message">${infoMessage}</div>` : ''}
                            `;
                            formRow.appendChild(formGroup);
                        });
                    };

                    if (Array.isArray(sectionFields)) {
                        createFields(sectionFields, section);
                    } else {
                        for (const subsection in sectionFields) {
                            const subsectionDiv = document.createElement('div');
                            subsectionDiv.innerHTML = `<h4>${subsection}</h4>`;
                            sectionContent.appendChild(subsectionDiv);
                            createFields(sectionFields[subsection], subsection);
                        }
                    }

                    dynamicSections.appendChild(sectionDiv);
                }
            }
        }

        function toggleSection(section) {
            section.classList.toggle('expanded');
            if (section.classList.contains('expanded')) {
                userExpandedSections.add(section.id);
            } else {
                userExpandedSections.delete(section.id);
            }
        }

        function expandSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && !section.classList.contains('expanded')) {
                section.classList.add('expanded');
            }
        }

        function collapseSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && section.classList.contains('expanded') && !userExpandedSections.has(sectionId)) {
                section.classList.remove('expanded');
            }
        }

        async function handleUserInput(userInput) {
            addChatbotMessage(userInput, true);

            if (userInput.toLowerCase().startsWith('change value of')) {
                const parts = userInput.split(' to ');
                if (parts.length === 2) {
                    const fieldName = parts[0].replace('change value of ', '').trim();
                    const newValue = parts[1].trim();
                    changeFieldValue(fieldName, newValue);
                    addChatbotMessage(`I've updated the value of ${fieldName} to ${newValue}. Let's continue with the next field.`);
                    askNextField();
                } else {
                    addChatbotMessage("I'm sorry, I didn't understand that. Please use the format 'change value of [field name] to [new value]'.");
                }
                return;
            }

            switch (conversationState) {
                case 'start':
                    if (userInput.toLowerCase().includes('yes') || userInput.toLowerCase().includes('ready')) {
                        addChatbotMessage("Great! Let's begin. What type of vessel are you reporting for? Please choose from Oil Tanker, LPG Tanker, or LNG Tanker.");
                        conversationState = 'select_vessel_type';
                    } else {
                        addChatbotMessage("No problem. When you're ready to start filling the form, just let me know by saying 'ready' or 'yes'.");
                    }
                    break;
                case 'select_vessel_type':
                    const vesselTypes = ["Oil Tanker", "LPG Tanker", "LNG Tanker"];
                    const normalizedInput = userInput.toLowerCase();
                    const matchedVesselType = vesselTypes.find(type => type.toLowerCase() === normalizedInput);
                    if (matchedVesselType) {
                        currentVesselType = matchedVesselType;
                        generateFormFields(currentVesselType);
                        conversationState = 'filling_form';
                        currentSectionIndex = 0;
                        currentFieldIndex = 0;
                        askNextField();
                    } else {
                        addChatbotMessage("I'm sorry, I didn't recognize that vessel type. Please choose from Oil Tanker, LPG Tanker, or LNG Tanker.");
                    }
                    break;
                case 'filling_form':
                    fillFormField(currentField, userInput);
                    askNextField();
                    break;
                case 'confirm_submit':
                    if (userInput.toLowerCase().includes('yes') || userInput.toLowerCase().includes('submit')) {
                        addChatbotMessage("Great! Your report has been submitted. Is there anything else I can help you with?");
                        conversationState = 'start';
                    } else {
                        addChatbotMessage("Okay, we won't submit the report yet. Let's continue filling the form.");
                        askNextField();
                    }
                    break;
                default:
                    addChatbotMessage("I'm not sure how to proceed. If you'd like to start a new report, please say 'new report'.");
                    conversationState = 'start';
            }
        }

        function askNextField() {
            const sections = Object.keys(SECTION_FIELDS);
            while (currentSectionIndex < sections.length) {
                currentSection = sections[currentSectionIndex];
                let fields = SECTION_FIELDS[currentSection];
                
                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    fields = fields[currentVesselType] || Object.values(fields).flat();
                }

                while (currentFieldIndex < fields.length) {
                    currentField = fields[currentFieldIndex];
                    const fieldId = currentField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    
                    if (inputElement && !inputElement.value) {
                        addChatbotMessage(`Please provide the ${currentField}:`);
                        expandSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                        return;
                    }
                    currentFieldIndex++;
                }
                collapseSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                currentSectionIndex++;
                currentFieldIndex = 0;
            }
            addChatbotMessage("Great job! You've completed all the fields. Would you like to submit the report now?");
            conversationState = 'confirm_submit';
        }

        function fillFormField(field, value) {
            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
            const inputElement = document.getElementById(fieldId);
            if (inputElement) {
                inputElement.value = value;
            }
        }

        function changeFieldValue(fieldName, newValue) {
            const normalizedFieldName = fieldName.toLowerCase();
            for (const section in SECTION_FIELDS) {
                const fields = SECTION_FIELDS[section];
                let sectionFields = [];

                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    sectionFields = fields[currentVesselType] || Object.values(fields).flat();
                } else {
                    sectionFields = fields;
                }

                const matchingField = sectionFields.find(field => field.toLowerCase().includes(normalizedFieldName));
                if (matchingField) {
                    const fieldId = matchingField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    if (inputElement) {
                        inputElement.value = newValue;
                        return;
                    }
                }
            }
            addChatbotMessage(`I couldn't find a field matching "${fieldName}". Please check the field name and try again.`);
        }

        document.getElementById('userInput').addEventListener('keypress', async function(event) {
            if (event.key === 'Enter') {
                const userInput = event.target.value.trim();
                event.target.value = '';
                if (userInput) {
                    await handleUserInput(userInput);
                }
            }
        });

        document.getElementById('reportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            addChatbotMessage("It looks like you're trying to submit the form. Are you sure you want to submit the report now?");
            conversationState = 'confirm_submit';
        });

        // Initialize the chatbot
        addChatbotMessage("Hello! I'm here to help you fill out the maritime report. Are you ready to begin?");
    </script>
</body>
</html>
