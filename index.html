<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiLog - Steer Your Reporting</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Nunito', sans-serif;
            background-color: #0f1824;
            color: #F4F4F4;
        }
        .container {
            display: flex;
            height: 100%;
        }
        .report-form {
            width: 70%;
            padding: 20px;
            overflow-y: auto;
            background-color: #1c2530;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 10px;
        }
        .chatbot {
            width: 30%;
            display: flex;
            flex-direction: column;
            background-color: #1c2530;
            border-left: 1px solid #e0e0e0;
        }
        .chatbot-header {
            padding: 10px;
            background-color: #114065;
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0;
        }
        .chatbot-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .chatbot-input {
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            background-color: #19364D;
            border-radius: 0 0 10px 10px;
        }
        .form-section {
            margin-bottom: 20px;
            background-color: #29323c;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: 1px solid #6E6E6E;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .form-section.highlight {
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
        }
        .form-section-header {
            cursor: pointer;
            user-select: none;
            font-weight: 600;
        }
        .form-section-content {
            display: none;
        }
        .form-section.expanded .form-section-content {
            display: block;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .form-group {
            flex: 1 1 23%;
            min-width: 150px;
            padding: 0 10px;
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #F4F4F4;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #6E6E6E;
            border-radius: 5px;
            transition: border-color 0.3s ease;
            font-size: 14px;
            background-color: #1c2530;
            color: #F4F4F4;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #3498db;
            outline: none;
        }
        #userInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #6E6E6E;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #19364D;
            color: #F4F4F4;
        }
        .chatbot-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
            font-size: 14px;
            background-color: #114065;
            color: #F4F4F4;
        }
        .user-message {
            background-color: #19364D;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background-color: #114065;
            align-self: flex-start;
        }
        .caution-message {
            background-color: #00AAFF;
            color: #000;
            align-self: flex-start;
        }
        button {
            background-color: #19364D;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:hover {
            background-color: #114065;
        }
        .field-prompt {
            font-size: 11px;
            color: #F4F4F4;
            margin-top: 2px;
        }
        .highlight-message {
            font-size: 11px;
            color: #00AAFF;
            background-color: #1c2530;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="report-form" id="reportFormContainer">
            <h2>OptiLog - Steer Your Reporting</h2>
            <form id="reportForm">
                <div id="dynamicSections"></div>
                <button type="submit">Submit Report</button>
                <button type="button" id="saveDraftButton">Save as Draft</button>
            </form>
        </div>
        <div class="chatbot">
            <div class="chatbot-header">
                <h2>Capt NaVya - Nav, Report, Go!</h2>
            </div>
            <div id="chatMessages" class="chatbot-messages"></div>
            <div class="chatbot-input">
                <input id="userInput" type="text" placeholder="Type your message and press Enter">
            </div>
        </div>
    </div>

    <script>
        const SECTION_FIELDS = {
            "Vessel Data": ["Vessel Name", "Vessel IMO", "Vessel Type"],
            "Voyage Data": ["Local Date", "Local Time", "UTC Offset", "Voyage ID", "Segment ID", "From Port", "To Port"],
            "Event Data": ["Event Type", "Sailing Time (hours)", "Ice Time (hours)", "Drifting (hours)"],
            "Position": [
                ["Latitude Degrees", "Latitude Minutes", "Latitude Direction"],
                ["Longitude Degrees", "Longitude Minutes", "Longitude Direction"]
            ],
            "Cargo": {
                "Oil Tanker": ["Cargo Weight (mt)"],
                "LPG Tanker": ["Cargo Volume (m3)"],
                "LNG Tanker": ["Cargo Volume (m3)"]
            },
            "Fuel Consumption": {
                "Oil Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "GCU": ["GCU LFO (mt)", "GCU MGO (mt)", "GCU LNG (mt)", "GCU Other (mt)", "GCU Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LPG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LPG Propane (mt)", "ME LPG Butane (mt)"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LPG Propane (mt)", "AE LPG Butane (mt)"],
                    "Aux Boilers": ["Aux Boiler LFO (mt)", "Aux Boiler MGO (mt)"],
                    "IGG": ["IGG MGO (mt)"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LNG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "GCU": ["GCU LFO (mt)", "GCU MGO (mt)", "GCU LNG (mt)", "GCU Other (mt)", "GCU Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                }
            },
            "ROB": ["LFO ROB (mt)", "MGO ROB (mt)"],
            "Fuel Allocation": {
                "Oil Tanker": {
                    "Cargo Heating": [
                        "Cargo Heating HFO (mt)", 
                        "Cargo Heating MGO (mt)", 
                        "Cargo Heating LNG (mt)", 
                        "Cargo Heating Other (mt)", 
                        "Cargo Heating Other Fuel Type"
                    ],
                    "Cargo Discharging": [
                        "Cargo Discharging HFO (mt)",
                        "Cargo Discharging MGO (mt)",
                        "Cargo Discharging LNG (mt)",
                        "Cargo Discharging Other (mt)",
                        "Cargo Discharging Other Fuel Type"
                    ],
                    "Engine Driven Cargo Pump": ["Engine Driven Cargo Pump MGO (mt)"]
                },
                "LPG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LPG Propane (mt)", "Cargo Cooling LPG Butane (mt)",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)",
                        "Discharge Pump LPG Propane (mt)", "Discharge Pump LPG Butane (mt)",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                },
                "LNG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LNG (mt)",
                        "Cargo Cooling Other (mt)", "Cargo Cooling Other Fuel Type",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)", "Discharge Pump LNG (mt)",
                        "Discharge Pump Other (mt)", "Discharge Pump Other Fuel Type",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                }
            },
            "Weather": {
                "Wind": ["Wind Direction (degrees)", "Wind Speed (knots)", "Wind Force (Beaufort)"],
                "Sea State": ["Sea State Direction (degrees)", "Sea State Force (Douglas scale)", "Sea State Period (seconds)"],
                "Swell": ["Swell Direction (degrees)", "Swell Height (meters)", "Swell Period (seconds)"],
                "Current": ["Current Direction (degrees)", "Current Speed (knots)"],
                "Temperature": ["Air Temperature (°C)", "Sea Temperature (°C)"]
            },
            "Draft": {
                "Actual": ["Actual Forward Draft (m)", "Actual Aft Draft (m)", "Displacement (mt)", "Water Depth (m)"]
            }
        };

        const BUNKERING_FIELDS = [
            "Bunker Type",
            "Quantity (mt)",
            "Density at 15°C (kg/m3)",
            "Viscosity at 50°C (cSt)",
            "Flash Point (°C)",
            "Sulphur Content (%)",
            "Water Content (%)",
            "Ash Content (%)",
            "Vanadium (mg/kg)",
            "Aluminium + Silicon (mg/kg)",
            "Pour Point (°C)",
            "Supplier Name",
            "Delivery Date",
            "Delivery Port",
            "BDN Number"
        ];

        const REPORT_TYPES = [
            "Arrival", "Departure", "Begin of offhire", "End of offhire", "Arrival STS", "Departure STS",
            "STS", "Begin canal passage", "End canal passage", "Begin of sea passage", "End of sea passage",
            "Begin Anchoring/Drifting", "End Anchoring/Drifting", "Noon (Position) - Sea passage",
            "Noon (Position) - Port", "Noon (Position) - River", "Noon (Position) - Stoppage",
            "ETA update", "Begin fuel change over", "End fuel change over", "Change destination (Deviation)",
            "Begin of deviation", "End of deviation", "Entering special area", "Leaving special area",
            "Other event", "Bunkering"
        ];

        let currentVesselType = 'LPG Tanker';
        let currentReportType = '';
        let currentSection = '';
        let currentField = '';
        let currentSectionIndex = 0;
        let currentFieldIndex = 0;
        let conversationState = 'select_report_type';
        let userExpandedSections = new Set();
        let validationAttempts = {
            "Main Engine": 0,
            "Auxiliary Engines": 0,
            "Aux Boilers": 0
        };

        const chatbotContainer = document.getElementById('chatMessages');

        async function getOpenAIResponse(prompt) {
            try {
                const response = await fetch('/.netlify/functions/openai-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ messages: [{ role: "user", content: prompt }] })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Received response from OpenAI API:", data);

                if (!data.choices || data.choices.length === 0) {
                    throw new Error('No response from OpenAI API');
                }

                return data.choices[0].message.content;
            } catch (error) {
                console.error("Error in OpenAI API call:", error);
                throw error;
            }
        }

        function addChatbotMessage(message, isUser = false, isCaution = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chatbot-message');
            messageDiv.classList.add(isUser ? 'user-message' : isCaution ? 'caution-message' : 'bot-message');
            messageDiv.innerHTML = `<p>${isUser ? '<strong>You:</strong> ' : isCaution ? '<strong>Caution:</strong> ' : '<strong>AI Assistant:</strong> '}${message}</p>`;
            chatbotContainer.appendChild(messageDiv);
            chatbotContainer.scrollTop = chatbotContainer.scrollHeight;
        }

        async function handleUserInput(userInput) {
            addChatbotMessage(userInput, true);

            if (conversationState === 'confirm_submit') {
                handleSubmissionConfirmation(userInput);
                return;
            }

            try {
                if (conversationState === 'select_report_type') {
                    const matchedReportType = REPORT_TYPES.find(type => userInput.toLowerCase().includes(type.toLowerCase()));
                    if (matchedReportType) {
                        currentReportType = matchedReportType;
                        generateFormFields(currentVesselType); // Regenerate form fields to include/exclude Bunkering section
                        fillInitialFormFields();
                        conversationState = 'filling_form';
                        currentSectionIndex = 0;
                        currentFieldIndex = 0;
                        askNextField();
                    } else {
                        addChatbotMessage("I didn't recognize that report type. Please choose from the list of report types I provided earlier.");
                    }
                } else if (conversationState === 'filling_form') {
                    if (userInput.toLowerCase() === 'null') {
                        addChatbotMessage(`Skipping ${currentField}.`);
                    } else {
                        const parentSection = SECTION_FIELDS[currentSection];
                        if (parentSection && parentSection.includes("Main Engine") && validationAttempts["Main Engine"] < 2) {
                            validateFuelConsumption(userInput, 25, "Main Engine");
                        } else if (parentSection && parentSection.includes("Auxiliary Engines") && validationAttempts["Auxiliary Engines"] < 2) {
                            validateFuelConsumption(userInput, 6, "Auxiliary Engines");
                        } else if (parentSection && parentSection.includes("Aux Boilers") && validationAttempts["Aux Boilers"] < 2) {
                            validateFuelConsumption(userInput, 3, "Aux Boilers");
                        } else {
                            fillFormField(currentField, userInput);
                            askNextField();
                        }
                    }
                }
            } catch (error) {
                console.error("Error in handleUserInput:", error);
                addChatbotMessage("I'm experiencing some technical difficulties. Please try again later.");
            }
        }

        function validateFuelConsumption(value, maxValue, section) {
            if (parseFloat(value) > maxValue) {
                validationAttempts[section]++;
                addChatbotMessage(`This does not pass the validation test. The value should be less than or equal to ${maxValue}. Do you still want to go with value more than ${maxValue}?`, false, true);
            } else {
                fillFormField(currentField, value);
                askNextField();
            }
        }

        function generateRandomLatLong() {
            const lat = Math.random() * 180 - 90;
            const long = Math.random() * 360 - 180;
            return {
                latDeg: Math.abs(Math.floor(lat)),
                latMin: Math.abs((lat % 1) * 60).toFixed(2),
                latDir: lat >= 0 ? 'N' : 'S',
                longDeg: Math.abs(Math.floor(long)),
                longMin: Math.abs((long % 1) * 60).toFixed(2),
                longDir: long >= 0 ? 'E' : 'W'
            };
        }

        function generateRandomConsumption(min, max) {
            return (Math.random() * (max - min) + min).toFixed(1);
        }

        function generateRandomVesselName() {
            const prefixes = ["MV", "SS", "MT"];
            const names = ["Horizon", "Voyager", "Pioneer", "Adventurer", "Explorer", "Discovery", "Navigator", "Endeavour", "Challenger", "Trailblazer"];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${names[Math.floor(Math.random() * names.length)]}`;
        }

        function generateRandomIMO() {
            return Math.floor(1000000 + Math.random() * 9000000).toString();
        }

        function generateFormFields(vesselType) {
            const dynamicSections = document.getElementById('dynamicSections');
            dynamicSections.innerHTML = '';

            const randomPosition = generateRandomLatLong();
            const randomVesselName = generateRandomVesselName();
            const randomIMO = generateRandomIMO();

            for (const section in SECTION_FIELDS) {
                const fields = SECTION_FIELDS[section];
                let sectionFields = [];

                if (Array.isArray(fields) && Array.isArray(fields[0])) {
                    sectionFields = fields.flat();
                } else if (typeof fields === 'object' && !Array.isArray(fields)) {
                    if (fields[vesselType]) {
                        sectionFields = fields[vesselType];
                    } else if (section !== "Cargo" && section !== "Fuel Consumption" && section !== "Fuel Allocation") {
                        sectionFields = fields;
                    }
                } else {
                    sectionFields = fields;
                }

                if (sectionFields && sectionFields.length > 0) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('form-section');
                    sectionDiv.id = section.replace(/\s+/g, '-').toLowerCase();
                    
                    const sectionHeader = document.createElement('div');
                    sectionHeader.classList.add('form-section-header');
                    sectionHeader.innerHTML = `<h3>${section}</h3>`;
                    sectionHeader.addEventListener('click', () => toggleSection(sectionDiv));
                    
                    const sectionContent = document.createElement('div');
                    sectionContent.classList.add('form-section-content');

                    sectionDiv.appendChild(sectionHeader);
                    sectionDiv.appendChild(sectionContent);

                    const createFields = (fields, parentSection) => {
                        let formRow;
                        fields.forEach((field, index) => {
                            if (index % 4 === 0) {
                                formRow = document.createElement('div');
                                formRow.classList.add('form-row');
                                sectionContent.appendChild(formRow);
                            }

                            const formGroup = document.createElement('div');
                            formGroup.classList.add('form-group');
                            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
                            let value = '';
                            let infoMessage = '';

                            if (section === 'Position' && field.includes('Latitude')) {
                                if (field.includes('Degrees')) value = randomPosition.latDeg;
                                else if (field.includes('Minutes')) value = randomPosition.latMin;
                                else if (field.includes('Direction')) value = randomPosition.latDir;
                                infoMessage = 'Current AIS position data';
                            } else if (section === 'Position' && field.includes('Longitude')) {
                                if (field.includes('Degrees')) value = randomPosition.longDeg;
                                else if (field.includes('Minutes')) value = randomPosition.longMin;
                                else if (field.includes('Direction')) value = randomPosition.longDir;
                                infoMessage = 'Current AIS position data';
                            } else if (field === 'Vessel Name') {
                                value = randomVesselName;
                            } else if (field === 'Vessel IMO') {
                                value = randomIMO;
                            } else if (field === 'Cargo Volume (m3)') {
                                value = '55000';
                                infoMessage = 'Value from last report';
                            } else if (field.includes('LFO')) {
                                if (parentSection === 'Main Engine') {
                                    value = generateRandomConsumption(20, 25);
                                    infoMessage = 'MFM figures';
                                } else if (parentSection === 'Auxiliary Engines') {
                                    value = generateRandomConsumption(2, 6);
                                    infoMessage = 'MFM figures';
                                } else if (parentSection === 'Aux Boilers') {
                                    value = generateRandomConsumption(1, 3);
                                    infoMessage = 'MFM figures';
                                }
                            }

                            formGroup.innerHTML = `
                                <label for="${fieldId}">${field}:</label>
                                <input type="text" id="${fieldId}" name="${field}" value="${value}">
                                ${infoMessage ? `<div class="highlight-message">${infoMessage}</div>` : ''}
                            `;
                            formRow.appendChild(formGroup);
                        });
                    };

                    if (Array.isArray(sectionFields)) {
                        createFields(sectionFields, section);
                    } else {
                        for (const subsection in sectionFields) {
                            const subsectionDiv = document.createElement('div');
                            subsectionDiv.innerHTML = `<h4>${subsection}</h4>`;
                            sectionContent.appendChild(subsectionDiv);
                            createFields(sectionFields[subsection], subsection);
                        }
                    }

                    dynamicSections.appendChild(sectionDiv);
                }
            }

            // Add Bunkering section only if it's a Bunkering report
            if (currentReportType.toLowerCase() === 'bunkering') {
                const bunkeringSection = document.createElement('div');
                bunkeringSection.classList.add('form-section');
                bunkeringSection.id = 'bunkering';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.classList.add('form-section-header');
                sectionHeader.innerHTML = `<h3>Bunkering</h3>`;
                sectionHeader.addEventListener('click', () => toggleSection(bunkeringSection));
                
                const sectionContent = document.createElement('div');
                sectionContent.classList.add('form-section-content');

                bunkeringSection.appendChild(sectionHeader);
                bunkeringSection.appendChild(sectionContent);

                let formRow;
                BUNKERING_FIELDS.forEach((field, index) => {
                    if (index % 4 === 0) {
                        formRow = document.createElement('div');
                        formRow.classList.add('form-row');
                        sectionContent.appendChild(formRow);
                    }

                    const formGroup = document.createElement('div');
                    formGroup.classList.add('form-group');
                    const fieldId = field.replace(/\s+/g, '-').toLowerCase();

                    formGroup.innerHTML = `
                        <label for="${fieldId}">${field}:</label>
                        <input type="text" id="${fieldId}" name="${field}">
                    `;
                    formRow.appendChild(formGroup);
                });

                dynamicSections.appendChild(bunkeringSection);
            }
        }

        function toggleSection(section) {
            section.classList.toggle('expanded');
            if (section.classList.contains('expanded')) {
                userExpandedSections.add(section.id);
            } else {
                userExpandedSections.delete(section.id);
            }
        }

        function expandSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && !section.classList.contains('expanded')) {
                section.classList.add('expanded');
            }
        }

        function collapseSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && section.classList.contains('expanded') && !userExpandedSections.has(sectionId)) {
                section.classList.remove('expanded');
            }
        }

        function fillInitialFormFields() {
            fillFormField('Vessel Type', currentVesselType);

            const now = new Date();
            fillFormField('Local Date', now.toISOString().split('T')[0]);
            fillFormField('Local Time', now.toTimeString().split(' ')[0]);
            
            const offset = -now.getTimezoneOffset() / 60;
            fillFormField('UTC Offset', offset.toString());

            const year = now.getFullYear().toString().substr(-2);
            const ladenOrBallast = Math.random() < 0.5 ? 'L' : 'B';
            const voyageId = `${Math.floor(Math.random() * 9 + 1)}/${year}/${ladenOrBallast}`;
            fillFormField('Voyage ID', voyageId);

            const segmentId = Math.floor(Math.random() * 5 + 1).toString();
            fillFormField('Segment ID', segmentId);

            const ports = ['Singapore', 'Rotterdam', 'Shanghai', 'Los Angeles', 'Dubai', 'Hamburg', 'New York'];
            const fromPort = ports[Math.floor(Math.random() * ports.length)];
            let toPort;
            do {
                toPort = ports[Math.floor(Math.random() * ports.length)];
            } while (toPort === fromPort);
            fillFormField('From Port', fromPort);
            fillFormField('To Port', toPort);

            fillFormField('Event Type', currentReportType);
            fillFormField('Sailing Time (hours)', '16.5');
        }

        function fillFormField(field, value) {
            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
            const inputElement = document.getElementById(fieldId);
            if (inputElement) {
                inputElement.value = value;
            }
        }

        function askNextField() {
            const sections = Object.keys(SECTION_FIELDS);
            while (currentSectionIndex < sections.length) {
                currentSection = sections[currentSectionIndex];
                let fields = SECTION_FIELDS[currentSection];
                
                if (Array.isArray(fields) && Array.isArray(fields[0])) {
                    fields = fields.flat();
                } else if (typeof fields === 'object' && !Array.isArray(fields)) {
                    fields = fields[currentVesselType] || Object.values(fields).flat();
                }

                while (currentFieldIndex < fields.length) {
                    currentField = fields[currentFieldIndex];
                    const fieldId = currentField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    
                    if (inputElement && !inputElement.value) {
                        addChatbotMessage(`Please provide the ${currentField} (or type 'null' to skip):`);
                        expandSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                        return;
                    }
                    currentFieldIndex++;
                }
                collapseSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                currentSectionIndex++;
                currentFieldIndex = 0;
            }

            // Check for Bunkering fields if it's a Bunkering report
            if (currentReportType.toLowerCase() === 'bunkering' && currentSectionIndex === sections.length) {
                while (currentFieldIndex < BUNKERING_FIELDS.length) {
                    currentField = BUNKERING_FIELDS[currentFieldIndex];
                    const fieldId = currentField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    
                    if (inputElement && !inputElement.value) {
                        addChatbotMessage(`Please provide the ${currentField} (or type 'null' to skip):`);
                        expandSection('bunkering');
                        return;
                    }
                    currentFieldIndex++;
                }
            }

            addChatbotMessage("Great job! You've completed all the fields. Would you like to submit the report now?");
            conversationState = 'confirm_submit';
        }

        function handleSubmissionConfirmation(userInput) {
            if (userInput.toLowerCase().includes('yes') || userInput.toLowerCase().includes('submit')) {
                submitReport();
            } else {
                addChatbotMessage("Okay, we won't submit the report yet. Let me know when you're ready to submit or if you need to make any changes.");
                conversationState = 'filling_form';
            }
        }

        function submitReport() {
            const formData = new FormData(document.getElementById('reportForm'));
            const reportData = Object.fromEntries(formData.entries());
            console.log("Submitting report:", reportData);
            
            addChatbotMessage("All fields validated, form submitted.");
            for (const [key, value] of Object.entries(reportData)) {
                addChatbotMessage(`${key}: ${value}`);
            }
            
            initApp();
        }

        function initApp() {
            console.log("Initializing application...");
            conversationState = 'select_report_type';
            currentVesselType = 'LPG Tanker';
            currentReportType = '';
            currentSection = '';
            currentField = '';
            currentSectionIndex = 0;
            currentFieldIndex = 0;
            userExpandedSections.clear();
            document.getElementById('dynamicSections').innerHTML = '';
            document.getElementById('chatMessages').innerHTML = '';
            addChatbotMessage("Welcome to NaVya, your maritime reporting assistant! We are generating a report for an LPG tanker. Please specify the type of report you'd like to create.");
        }

        document.getElementById('userInput').addEventListener('keypress', async function(event) {
            if (event.key === 'Enter') {
                const userInput = event.target.value.trim();
                event.target.value = '';
                if (userInput) {
                    await handleUserInput(userInput);
                }
            }
        });

        document.getElementById('reportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            addChatbotMessage("It looks like you're trying to submit the form. Are you sure you want to submit the report now?");
            conversationState = 'confirm_submit';
        });

        document.getElementById('saveDraftButton').addEventListener('click', function(event) {
            addChatbotMessage("Form saved as draft.");
        });

        window.onload = initApp;
    </script>
</body>
</html>
