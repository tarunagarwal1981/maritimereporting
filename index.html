<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiLog - Steer Your Reporting</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .container {
            display: flex;
            height: 100%;
        }
        .report-form {
            width: 70%;
            padding: 20px;
            overflow-y: auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .chatbot {
            width: 30%;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            border-left: 1px solid #e0e0e0;
        }
        .chatbot-header {
            padding: 20px;
            background-color: #3498db;
            color: white;
            font-weight: 500;
        }
        .chatbot-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .chatbot-input {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .form-section {
            margin-bottom: 20px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid #e6e6e6;
        }
        .form-section.highlight {
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
        }
        .form-section-header {
            cursor: pointer;
            user-select: none;
        }
        .form-section-content {
            display: none;
        }
        .form-section.expanded .form-section-content {
            display: block;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .form-group {
            flex: 1 1 30%;
            min-width: 200px;
            padding: 0 10px;
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            transition: border-color 0.3s ease;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #3498db;
            outline: none;
        }
        #userInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .chatbot-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
            font-size: 14px;
        }
        .user-message {
            background-color: #e6f2ff;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background-color: #f0f0f0;
            align-self: flex-start;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #2980b9;
        }
        .field-prompt {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        .info-message {
            font-size: 11px;
            color: #0066cc;
            background-color: #e6f2ff;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="report-form" id="reportFormContainer">
            <h2>OptiLog - Steer Your Reporting</h2>
            <form id="reportForm">
                <div id="dynamicSections"></div>
                <button type="submit">Submit Report</button>
            </form>
        </div>
        <div class="chatbot">
            <div class="chatbot-header">
                <h2>NaVya</h2>
            </div>
            <div id="chatMessages" class="chatbot-messages"></div>
            <div class="chatbot-input">
                <input id="userInput" type="text" placeholder="Type your message and press Enter">
            </div>
        </div>
    </div>

    <script>
        const SECTION_FIELDS = {
            "Vessel Data": ["Vessel Name", "Vessel IMO", "Vessel Type"],
            "Voyage Data": ["Local Date", "Local Time", "UTC Offset", "Voyage ID", "Segment ID", "From Port", "To Port"],
            "Event Data": ["Event Type", "Time Elapsed (hours)", "Sailing Time (hours)", "Anchor Time (hours)", "Ice Time (hours)", "Maneuvering (hours)", "Loading/Unloading (hours)", "Drifting (hours)"],
            "Position": ["Latitude Degrees", "Latitude Minutes", "Latitude Direction", "Longitude Degrees", "Longitude Minutes", "Longitude Direction"],
            "Cargo": {
                "Oil Tanker": ["Cargo Weight (mt)"],
                "LPG Tanker": ["Cargo Volume (m3)"],
                "LNG Tanker": ["Cargo Volume (m3)"]
            },
            "Fuel Consumption": {
                "Oil Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LPG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME LPG Propane (mt)", "ME LPG Butane (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE LPG Propane (mt)", "AE LPG Butane (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler LPG Propane (mt)", "Boiler LPG Butane (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG LPG Propane (mt)", "IGG LPG Butane (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                },
                "LNG Tanker": {
                    "Main Engine": ["ME LFO (mt)", "ME MGO (mt)", "ME LNG (mt)", "ME Other (mt)", "ME Other Fuel Type"],
                    "Auxiliary Engines": ["AE LFO (mt)", "AE MGO (mt)", "AE LNG (mt)", "AE Other (mt)", "AE Other Fuel Type"],
                    "Boilers": ["Boiler LFO (mt)", "Boiler MGO (mt)", "Boiler LNG (mt)", "Boiler Other (mt)", "Boiler Other Fuel Type"],
                    "IGG": ["IGG LFO (mt)", "IGG MGO (mt)", "IGG LNG (mt)", "IGG Other (mt)", "IGG Other Fuel Type"],
                    "GCU": ["GCU LFO (mt)", "GCU MGO (mt)", "GCU LNG (mt)", "GCU Other (mt)", "GCU Other Fuel Type"],
                    "Incinerator": ["Incinerator MGO (mt)"]
                }
            },
            "ROB": ["LFO ROB (mt)", "MGO ROB (mt)", "LNG ROB (mt)", "Other ROB (mt)", "Other Fuel Type ROB", "Total Fuel ROB (mt)"],
            "Fuel Allocation": {
                "Oil Tanker": {
                    "Cargo Heating": [
                        "Cargo Heating HFO (mt)", 
                        "Cargo Heating MGO (mt)", 
                        "Cargo Heating LNG (mt)", 
                        "Cargo Heating Other (mt)", 
                        "Cargo Heating Other Fuel Type"
                    ],
                    "Cargo Discharging": [
                        "Cargo Discharging HFO (mt)",
                        "Cargo Discharging MGO (mt)",
                        "Cargo Discharging LNG (mt)",
                        "Cargo Discharging Other (mt)",
                        "Cargo Discharging Other Fuel Type"
                    ],
                    "Engine Driven Cargo Pump": ["Engine Driven Cargo Pump MGO (mt)"]
                },
                "LPG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LNG (mt)",
                        "Cargo Cooling LPG Propane (mt)", "Cargo Cooling LPG Butane (mt)",
                        "Cargo Cooling Other (mt)", "Cargo Cooling Other Fuel Type",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)", "Discharge Pump LNG (mt)",
                        "Discharge Pump LPG Propane (mt)", "Discharge Pump LPG Butane (mt)",
                        "Discharge Pump Other (mt)", "Discharge Pump Other Fuel Type",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                },
                "LNG Tanker": {
                    "Cargo Cooling": [
                        "Cargo Cooling LFO (mt)", "Cargo Cooling MGO (mt)", "Cargo Cooling LNG (mt)",
                        "Cargo Cooling Other (mt)", "Cargo Cooling Other Fuel Type",
                        "Cargo Cooling Work (kWh)", "Cargo Cooling SFOC (g/kWh)"
                    ],
                    "Discharge Pump": [
                        "Discharge Pump LFO (mt)", "Discharge Pump MGO (mt)", "Discharge Pump LNG (mt)",
                        "Discharge Pump Other (mt)", "Discharge Pump Other Fuel Type",
                        "Discharge Pump Work (kWh)", "Discharge Pump SFOC (g/kWh)"
                    ],
                    "Shore-Side Electricity": ["Shore-Side Electricity Work (kWh)"]
                }
            },
            "Weather": {
                "Wind": ["Wind Direction (degrees)", "Wind Speed (knots)", "Wind Force (Beaufort)"],
                "Sea State": ["Sea State Direction (degrees)", "Sea State Force (Douglas scale)", "Sea State Period (seconds)"],
                "Swell": ["Swell Direction (degrees)", "Swell Height (meters)", "Swell Period (seconds)"],
                "Current": ["Current Direction (degrees)", "Current Speed (knots)"],
                "Temperature": ["Air Temperature (°C)", "Sea Temperature (°C)"]
            },
            "Draft": {
                "Actual": ["Actual Forward Draft (m)", "Actual Aft Draft (m)", "Displacement (mt)", "Water Depth (m)"]
            },
            "Bunker": [
                "Bunker Type",
                "Quantity (mt)",
                "Density at 15°C (kg/m3)",
                "Viscosity at 50°C (cSt)",
                "Flash Point (°C)",
                "Sulphur Content (%)",
                "Water Content (%)",
                "Ash Content (%)",
                "Vanadium (mg/kg)",
                "Aluminium + Silicon (mg/kg)",
                "Pour Point (°C)",
                "Supplier Name",
                "Delivery Date",
                "Delivery Port",
                "BDN Number"
            ]
        };

        const REPORT_TYPES = [
            "Arrival", "Departure", "Begin of offhire", "End of offhire", "Arrival STS", "Departure STS",
            "STS", "Begin canal passage", "End canal passage", "Begin of sea passage", "End of sea passage",
            "Begin Anchoring/Drifting", "End Anchoring/Drifting", "Noon (Position) - Sea passage",
            "Noon (Position) - Port", "Noon (Position) - River", "Noon (Position) - Stoppage",
            "ETA update", "Begin fuel change over", "End fuel change over", "Change destination (Deviation)",
            "Begin of deviation", "End of deviation", "Entering special area", "Leaving special area",
            "Other event", "Bunkering"
        ];

        let currentVesselType = '';
        let currentSection = '';
        let currentField = '';
        let currentSectionIndex = 0;
        let currentFieldIndex = 0;
        let conversationState = 'start';
        let userExpandedSections = new Set();

        const chatbotContainer = document.getElementById('chatMessages');

        async function getOpenAIResponse(prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${process.env.OPENAIAPIKEY}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: `You are NaVya, an AI assistant for maritime reporting. Your task is to guide users through creating maritime reports, ensuring compliance with industry standards and regulations. 

                            Vessel Types: Container vessel, Bulk Carrier, Oil Tanker, LPG tanker, LNG tanker

                            Report Types: ${REPORT_TYPES.join(', ')}

                            Instructions:
                            1. Ask for the vessel type if not provided.
                            2. Suggest appropriate report types based on the vessel type and logical sequence of maritime operations.
                            3. Guide the user through filling out the report form, which is pre-filled with random values for certain fields.
                            4. Ask for values for each non-pre-filled field, providing helpful guidance and reminders.
                            5. Inform users they can change pre-filled values by saying "change value of [field name] to [new value]".
                            6. Provide clear, concise responses and ask for one piece of information at a time.
                            7. Ensure all required fields are filled before suggesting report submission.`
                        },
                        {role: "user", content: prompt}
                    ],
                    max_tokens: 150
                })
            });

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function addChatbotMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chatbot-message');
            messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
            messageDiv.innerHTML = `<p>${isUser ? '<strong>You:</strong> ' : '<strong>AI Assistant:</strong> '}${message}</p>`;
            chatbotContainer.appendChild(messageDiv);
            chatbotContainer.scrollTop = chatbotContainer.scrollHeight;
        }

        function generateRandomLatLong() {
            const lat = Math.random() * 180 - 90;
            const long = Math.random() * 360 - 180;
            return {
                latDeg: Math.abs(Math.floor(lat)),
                latMin: Math.abs((lat % 1) * 60).toFixed(2),
                latDir: lat >= 0 ? 'N' : 'S',
                longDeg: Math.abs(Math.floor(long)),
                longMin: Math.abs((long % 1) * 60).toFixed(2),
                longDir: long >= 0 ? 'E' : 'W'
            };
        }

        function generateRandomConsumption(min, max) {
            return (Math.random() * (max - min) + min).toFixed(1);
        }

        function generateRandomVesselName() {
            const prefixes = ["MV", "SS", "MT"];
            const names = ["Horizon", "Voyager", "Pioneer", "Adventurer", "Explorer", "Discovery", "Navigator", "Endeavour", "Challenger", "Trailblazer"];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${names[Math.floor(Math.random() * names.length)]}`;
        }

        function generateRandomIMO() {
            return Math.floor(1000000 + Math.random() * 9000000).toString();
        }

        function generateFormFields(vesselType) {
            const dynamicSections = document.getElementById('dynamicSections');
            dynamicSections.innerHTML = '';

            const randomPosition = generateRandomLatLong();
            const randomVesselName = generateRandomVesselName();
            const randomIMO = generateRandomIMO();

            for (const section in SECTION_FIELDS) {
                const fields = SECTION_FIELDS[section];
                let sectionFields = [];

                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    if (fields[vesselType]) {
                        sectionFields = fields[vesselType];
                    } else if (section !== "Cargo" && section !== "Fuel Consumption" && section !== "Fuel Allocation") {
                        sectionFields = fields;
                    }
                } else {
                    sectionFields = fields;
                }

                if (sectionFields && Object.keys(sectionFields).length > 0) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('form-section');
                    sectionDiv.id = section.replace(/\s+/g, '-').toLowerCase();
                    
                    const sectionHeader = document.createElement('div');
                    sectionHeader.classList.add('form-section-header');
                    sectionHeader.innerHTML = `<h3>${section}</h3>`;
                    sectionHeader.addEventListener('click', () => toggleSection(sectionDiv));
                    
                    const sectionContent = document.createElement('div');
                    sectionContent.classList.add('form-section-content');

                    sectionDiv.appendChild(sectionHeader);
                    sectionDiv.appendChild(sectionContent);

                    const createFields = (fields, parentSection) => {
                        let formRow;
                        fields.forEach((field, index) => {
                            if (index % 3 === 0) {
                                formRow = document.createElement('div');
                                formRow.classList.add('form-row');
                                sectionContent.appendChild(formRow);
                            }

                            const formGroup = document.createElement('div');
                            formGroup.classList.add('form-group');
                            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
                            let value = '';
                            let infoMessage = '';

                            if (section === 'Position' && field.includes('Latitude')) {
                                if (field.includes('Degrees')) value = randomPosition.latDeg;
                                else if (field.includes('Minutes')) value = randomPosition.latMin;
                                else if (field.includes('Direction')) value = randomPosition.latDir;
                                infoMessage = 'Current AIS position';
                            } else if (section === 'Position' && field.includes('Longitude')) {
                                if (field.includes('Degrees')) value = randomPosition.longDeg;
                                else if (field.includes('Minutes')) value = randomPosition.longMin;
                                else if (field.includes('Direction')) value = randomPosition.longDir;
                                infoMessage = 'Current AIS position';
                            } else if (field === 'Vessel Name') {
                                value = randomVesselName;
                            } else if (field === 'Vessel IMO') {
                                value = randomIMO;
                            } else if (field.includes('LFO')) {
                                if (parentSection === 'Main Engine') {
                                    value = generateRandomConsumption(20, 25);
                                } else if (parentSection === 'Auxiliary Engines') {
                                    value = generateRandomConsumption(2, 3);
                                } else if (parentSection === 'Boilers') {
                                    value = generateRandomConsumption(1, 2);
                                }
                                infoMessage = 'MFM figures since last report';
                            }

                            formGroup.innerHTML = `
                                <label for="${fieldId}">${field}:</label>
                                <input type="text" id="${fieldId}" name="${field}" value="${value}">
                                ${infoMessage ? `<div class="info-message">${infoMessage}</div>` : ''}
                            `;
                            formRow.appendChild(formGroup);
                        });
                    };

                    if (Array.isArray(sectionFields)) {
                        createFields(sectionFields, section);
                    } else {
                        for (const subsection in sectionFields) {
                            const subsectionDiv = document.createElement('div');
                            subsectionDiv.innerHTML = `<h4>${subsection}</h4>`;
                            sectionContent.appendChild(subsectionDiv);
                            createFields(sectionFields[subsection], subsection);
                        }
                    }

                    dynamicSections.appendChild(sectionDiv);
                }
            }
        }

        function toggleSection(section) {
            section.classList.toggle('expanded');
            if (section.classList.contains('expanded')) {
                userExpandedSections.add(section.id);
            } else {
                userExpandedSections.delete(section.id);
            }
        }

        function expandSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && !section.classList.contains('expanded')) {
                section.classList.add('expanded');
            }
        }

        function collapseSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && section.classList.contains('expanded') && !userExpandedSections.has(sectionId)) {
                section.classList.remove('expanded');
            }
        }

        async function handleUserInput(userInput) {
            addChatbotMessage(userInput, true);

            let prompt = `Current conversation state: ${conversationState}\nUser input: ${userInput}\n`;
            prompt += `Vessel type: ${currentVesselType}\nCurrent section: ${currentSection}\nCurrent field: ${currentField}\n`;
            prompt += "Please provide a response to guide the user through the maritime reporting process.";

            try {
                console.log("Sending request to OpenAI API...");
                const aiResponse = await getOpenAIResponse(prompt);
                console.log("Received response from OpenAI API:", aiResponse);
                addChatbotMessage(aiResponse);

                // Process the AI response
                if (aiResponse.toLowerCase().includes("vessel type")) {
                    conversationState = 'select_vessel_type';
                } else if (aiResponse.toLowerCase().includes("report type")) {
                    conversationState = 'select_report_type';
                } else if (aiResponse.toLowerCase().includes("let's begin filling")) {
                    conversationState = 'filling_form';
                    currentSectionIndex = 0;
                    currentFieldIndex = 0;
                    askNextField();
                } else if (aiResponse.toLowerCase().includes("submit the report")) {
                    conversationState = 'confirm_submit';
                }

                // Handle field value changes
                const fieldUpdateMatch = aiResponse.match(/change value of (.*?) to (.*)/i);
                if (fieldUpdateMatch) {
                    const [, fieldName, newValue] = fieldUpdateMatch;
                    changeFieldValue(fieldName, newValue);
                }

                // Process user input based on conversation state
                if (conversationState === 'select_vessel_type') {
                    const vesselTypes = ["Container vessel", "Bulk Carrier", "Oil Tanker", "LPG tanker", "LNG tanker"];
                    const matchedVesselType = vesselTypes.find(type => userInput.toLowerCase().includes(type.toLowerCase()));
                    if (matchedVesselType) {
                        currentVesselType = matchedVesselType;
                        generateFormFields(currentVesselType);
                        conversationState = 'select_report_type';
                    }
                } else if (conversationState === 'select_report_type') {
                    const matchedReportType = REPORT_TYPES.find(type => userInput.toLowerCase().includes(type.toLowerCase()));
                    if (matchedReportType) {
                        currentSection = 'Vessel Data';
                        currentField = SECTION_FIELDS['Vessel Data'][0];
                        conversationState = 'filling_form';
                        askNextField();
                    }
                } else if (conversationState === 'filling_form') {
                    fillFormField(currentField, userInput);
                    askNextField();
                }

            } catch (error) {
                console.error("Error calling OpenAI API:", error);
                addChatbotMessage("I'm sorry, I'm having trouble processing your request. Please try again later.");
            }
        }

        function askNextField() {
            const sections = Object.keys(SECTION_FIELDS);
            while (currentSectionIndex < sections.length) {
                currentSection = sections[currentSectionIndex];
                let fields = SECTION_FIELDS[currentSection];
                
                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    fields = fields[currentVesselType] || Object.values(fields).flat();
                }

                while (currentFieldIndex < fields.length) {
                    currentField = fields[currentFieldIndex];
                    const fieldId = currentField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    
                    if (inputElement && !inputElement.value) {
                        addChatbotMessage(`Please provide the ${currentField}:`);
                        expandSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                        return;
                    }
                    currentFieldIndex++;
                }
                collapseSection(currentSection.replace(/\s+/g, '-').toLowerCase());
                currentSectionIndex++;
                currentFieldIndex = 0;
            }
            addChatbotMessage("Great job! You've completed all the fields. Would you like to submit the report now?");
            conversationState = 'confirm_submit';
        }

        function fillFormField(field, value) {
            const fieldId = field.replace(/\s+/g, '-').toLowerCase();
            const inputElement = document.getElementById(fieldId);
            if (inputElement) {
                inputElement.value = value;
            }
        }

        function changeFieldValue(fieldName, newValue) {
            const normalizedFieldName = fieldName.toLowerCase();
            for (const section in SECTION_FIELDS) {
                const fields = SECTION_FIELDS[section];
                let sectionFields = [];

                if (typeof fields === 'object' && !Array.isArray(fields)) {
                    sectionFields = fields[currentVesselType] || Object.values(fields).flat();
                } else {
                    sectionFields = fields;
                }

                const matchingField = sectionFields.find(field => field.toLowerCase().includes(normalizedFieldName));
                if (matchingField) {
                    const fieldId = matchingField.replace(/\s+/g, '-').toLowerCase();
                    const inputElement = document.getElementById(fieldId);
                    if (inputElement) {
                        inputElement.value = newValue;
                        return;
                    }
                }
            }
            addChatbotMessage(`I couldn't find a field matching "${fieldName}". Please check the field name and try again.`);
        }

        document.getElementById('userInput').addEventListener('keypress', async function(event) {
            if (event.key === 'Enter') {
                const userInput = event.target.value.trim();
                event.target.value = '';
                if (userInput) {
                    await handleUserInput(userInput);
                }
            }
        });

        document.getElementById('reportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            addChatbotMessage("It looks like you're trying to submit the form. Are you sure you want to submit the report now?");
            conversationState = 'confirm_submit';
        });

        // Initialize the chatbot
        addChatbotMessage("Welcome to NaVya, your maritime reporting assistant! I'm here to help you create a report. Please tell me the type of vessel you're reporting for.");

        // Function to initialize the application
        function initApp() {
            console.log("Initializing application...");
            conversationState = 'start';
            currentVesselType = '';
            currentSection = '';
            currentField = '';
            currentSectionIndex = 0;
            currentFieldIndex = 0;
            userExpandedSections.clear();
            document.getElementById('dynamicSections').innerHTML = '';
            document.getElementById('chatMessages').innerHTML = '';
            addChatbotMessage("Welcome to NaVya, your maritime reporting assistant! I'm here to help you create a report. Please tell me the type of vessel you're reporting for.");
        }

        // Call initApp when the page loads
        window.onload = initApp;

        // Error handling for OpenAI API
        function handleOpenAIError(error) {
            console.error("OpenAI API Error:", error);
            addChatbotMessage("I'm experiencing some technical difficulties. Please try again later or contact support if the problem persists.");
        }

        // Function to validate form before submission
        function validateForm() {
            let isValid = true;
            const requiredFields = document.querySelectorAll('input[required]');
            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.classList.add('error');
                } else {
                    field.classList.remove('error');
                }
            });
            return isValid;
        }

        // Function to submit the report
        async function submitReport() {
            if (validateForm()) {
                const formData = new FormData(document.getElementById('reportForm'));
                const reportData = Object.fromEntries(formData.entries());
                console.log("Submitting report:", reportData);
                
                // Here you would typically send the data to your server
                // For this example, we'll just log it and show a success message
                addChatbotMessage("Report submitted successfully! Here's a summary of your report:");
                for (const [key, value] of Object.entries(reportData)) {
                    addChatbotMessage(`${key}: ${value}`);
                }
                
                // Reset the form and start over
                initApp();
            } else {
                addChatbotMessage("Please fill in all required fields before submitting the report.");
            }
        }

        // Update the event listener for form submission
        document.getElementById('reportForm').addEventListener('submit', function(event) {
            event.preventDefault();
            if (conversationState === 'confirm_submit') {
                submitReport();
            } else {
                addChatbotMessage("It looks like you're trying to submit the form. Are you sure you want to submit the report now?");
                conversationState = 'confirm_submit';
            }
        });

        // Function to handle user confirmation of report submission
        function handleSubmissionConfirmation(userInput) {
            if (userInput.toLowerCase().includes('yes') || userInput.toLowerCase().includes('submit')) {
                submitReport();
            } else {
                addChatbotMessage("Okay, we won't submit the report yet. Let me know when you're ready to submit or if you need to make any changes.");
                conversationState = 'filling_form';
            }
        }

        // Update handleUserInput function to include submission confirmation
        async function handleUserInput(userInput) {
            addChatbotMessage(userInput, true);

            if (conversationState === 'confirm_submit') {
                handleSubmissionConfirmation(userInput);
                return;
            }

            let prompt = `Current conversation state: ${conversationState}\nUser input: ${userInput}\n`;
            prompt += `Vessel type: ${currentVesselType}\nCurrent section: ${currentSection}\nCurrent field: ${currentField}\n`;
            prompt += "Please provide a response to guide the user through the maritime reporting process.";

            try {
                console.log("Sending request to OpenAI API...");
                const aiResponse = await getOpenAIResponse(prompt);
                console.log("Received response from OpenAI API:", aiResponse);
                addChatbotMessage(aiResponse);

                // Process the AI response
                if (aiResponse.toLowerCase().includes("vessel type")) {
                    conversationState = 'select_vessel_type';
                } else if (aiResponse.toLowerCase().includes("report type")) {
                    conversationState = 'select_report_type';
                } else if (aiResponse.toLowerCase().includes("let's begin filling")) {
                    conversationState = 'filling_form';
                    currentSectionIndex = 0;
                    currentFieldIndex = 0;
                    askNextField();
                } else if (aiResponse.toLowerCase().includes("submit the report")) {
                    conversationState = 'confirm_submit';
                }

                // Handle field value changes
                const fieldUpdateMatch = aiResponse.match(/change value of (.*?) to (.*)/i);
                if (fieldUpdateMatch) {
                    const [, fieldName, newValue] = fieldUpdateMatch;
                    changeFieldValue(fieldName, newValue);
                }

                // Process user input based on conversation state
                if (conversationState === 'select_vessel_type') {
                    const vesselTypes = ["Container vessel", "Bulk Carrier", "Oil Tanker", "LPG tanker", "LNG tanker"];
                    const matchedVesselType = vesselTypes.find(type => userInput.toLowerCase().includes(type.toLowerCase()));
                    if (matchedVesselType) {
                        currentVesselType = matchedVesselType;
                        generateFormFields(currentVesselType);
                        conversationState = 'select_report_type';
                    }
                } else if (conversationState === 'select_report_type') {
                    const matchedReportType = REPORT_TYPES.find(type => userInput.toLowerCase().includes(type.toLowerCase()));
                    if (matchedReportType) {
                        currentSection = 'Vessel Data';
                        currentField = SECTION_FIELDS['Vessel Data'][0];
                        conversationState = 'filling_form';
                        askNextField();
                    }
                } else if (conversationState === 'filling_form') {
                    fillFormField(currentField, userInput);
                    askNextField();
                }

            } catch (error) {
                handleOpenAIError(error);
            }
        }

    </script>
</body>
</html>    
